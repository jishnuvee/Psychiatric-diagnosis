---
title: "Visuals "
format: html
execute:
  echo: false
  warning: false
  message: false
---

```{r}
# Load libraries quietly
suppressPackageStartupMessages({
  library(tidyverse)
  library(ggplot2)
  library(dplyr)
  library(tidyr)
  library(plotly)
  library(htmlwidgets)
})

# Load dataset
extract_path <- "C:/Users/jishn/projects/Psychiatric-diagnosis"
file_path <- file.path(extract_path, "EEG.machinelearing_data_BRMH.csv")
x <- read.csv(file_path)

library(ggplot2)
library(dplyr)
library(tidyr)

# Load data
data <- read.csv("EEG.machinelearing_data_BRMH.csv")

# Identify key delta electrodes by exact match
key_delta_cols <- c("AB.A.delta.a.FP1",
                    "AB.A.delta.d.F3",
                    "AB.A.delta.i.C3",
                    "AB.A.delta.o.Pz",
                    "AB.A.delta.r.O1")
```

```{r}
#| fig-height: 8

# Create interactive dropdown plot using plotly
library(crosstalk)

# Ensure Healthy control appears first in factor levels
x$specific.disorder <- factor(x$specific.disorder,
                              levels = c("Healthy control",
                                       setdiff(unique(x$specific.disorder), "Healthy control")))

# Get all EEG feature columns
eeg_features <- names(x)[grep("AB.A", names(x))]

# Create plots for each feature
create_eeg_plot <- function(feature_name) {
  feature_col <- sym(feature_name)
 
  plot_data <- x %>%
    select(specific.disorder, !!feature_col) %>%
    filter(!is.na(specific.disorder), !is.na(!!feature_col)) %>%
    mutate(
      clean_labels = gsub(" disorder", "", specific.disorder, ignore.case = TRUE),
      legend_labels = specific.disorder
    ) %>%
    mutate(
      clean_labels = factor(clean_labels, levels = c("Healthy control", setdiff(unique(clean_labels), "Healthy control"))),
      legend_labels = factor(legend_labels, levels = c("Healthy control", setdiff(unique(legend_labels), "Healthy control")))
    )
 
  electrode_name <- gsub(".*\\.", "", gsub("AB\\.A\\.[^.]*\\.[^.]*\\.", "", feature_name))
 
  p <- plot_ly(
    plot_data,
    x = ~clean_labels,
    y = as.formula(paste0("~`", feature_name, "`")),
    type = 'box',
    color = ~legend_labels,
    boxpoints = 'all',
    jitter = 0.3,
    pointpos = -1.8,
    visible = if(feature_name == "AB.A.delta.a.FP1") TRUE else FALSE
  ) %>%
    layout(
      title = list(
        text = paste("EEG Delta Power at", electrode_name, "Electrode"),
        x = 0.5,
        xanchor = 'center',
        y = 0.95
      ),
      xaxis = list(
        title = "Psychiatric Disorder",
        tickangle = -45
      ),
      yaxis = list(
        title = "Delta Power",
        titlefont = list(size = 14)
      ),
      margin = list(b = 150, t = 150, l = 80, r = 80),
      annotations = list(
        list(
          text = "Interactive comparison of EEG delta power across psychiatric disorders and healthy controls",
          x = 0.5,
          y = 0.88,
          xref = "paper",
          yref = "paper",
          showarrow = FALSE,
          xanchor = "center",
          font = list(size = 11, color = "gray40")
        )
      )
    )
  return(p)
}

# Create all plots
all_plots <- map(eeg_features, create_eeg_plot)

# Combine into a single plot with dropdown
combined_plot <- all_plots[[1]]

for(i in 2:length(all_plots)) {
  combined_plot <- combined_plot %>% add_trace(data = all_plots[[i]]$x$data[[1]])
}

# Add dropdown menu with better positioning
combined_plot <- combined_plot %>%
  layout(
    updatemenus = list(
      list(
        type = "dropdown",
        direction = "down",
        x = 0.02,
        y = 0.98,
        xanchor = "left",
        yanchor = "top",
        showactive = TRUE,
        bgcolor = "rgba(255,255,255,0.9)",
        bordercolor = "rgba(0,0,0,0.3)",
        borderwidth = 1,
        font = list(size = 12),
        buttons = map2(eeg_features, seq_along(eeg_features), function(feature, idx) {
          electrode_name <- gsub(".*\\.", "", gsub("AB\\.A\\.[^.]*\\.[^.]*\\.", "", feature))
          visible_array <- rep(FALSE, length(eeg_features))
          visible_array[idx] <- TRUE
         
          list(
            label = paste(electrode_name, "Electrode"),
            method = "update",
            args = list(
              list(visible = visible_array),
              list(title = list(text = paste("EEG Delta Power at", electrode_name, "Electrode")))
            )
          )
        })
      )
    )
  )

combined_plot
```

 This graph allows for comparison of EEG delta power measurements across different electrode positions between psychiatric disorders and healthy controls. The box plots reveal that most psychiatric conditions exhibit elevated delta power compared to healthy controls, with notable variations across different brain regions and disorder types. The dropdown menu enables exploration of specific electrode locations, showing consistent patterns where disorders like acute stress, adjustment disorder, and schizophrenia demonstrate particularly pronounced increases in slow-wave brain activity, suggesting altered neural functioning in these conditions.





