---
title: "Model"
format: html
execute: 
  echo: false
---

## Data Preprocessing and Model Fitting


# EEG Multinomial Regression with Individual Delta Power





This analysis uses the real EEG dataset (`EEG.machinelearing_data_BRMH.csv`) to predict `specific.disorder` using multinomial logistic regression. Predictors include demographic variables (`education`, `age`, `sex`, `IQ`) and individual delta power measurements from frontal electrodes (`AB.A.delta.a.FP1`, `AB.A.delta.b.FP2`, `AB.A.delta.c.F7`, `AB.A.delta.d.F3`, `AB.A.delta.e.Fz`, `AB.A.delta.f.F4`, `AB.A.delta.g.F8`).

### Model Equations
The model estimates log-odds for each disorder relative to a reference category (set to "Healthy control" if present, otherwise the first alphabetical category). Coefficients are derived from the data and shown below.

```{r}
#| warning: false
#| message: false

# Load required packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(tidymodels)
  library(yardstick)
  library(nnet)  # For multinom function
  library(car)   # For VIF calculation
})

# Set random seed for reproducibility
set.seed(123)

# Load the real dataset
df <- read_csv("EEG.machinelearing_data_BRMH.csv")

# Preprocess the data
df <- df %>%
  # Convert sex and specific.disorder to factors
  mutate(
    sex = as.factor(sex),
    specific.disorder = as.factor(specific.disorder)
  ) %>%
  # Set "Healthy control" as reference level if it exists
  mutate(
    specific.disorder = relevel(specific.disorder, ref = "Healthy control")
  ) %>%
  # Remove rows with missing values in predictors or outcome
  filter(complete.cases(education, age, sex, IQ, 
                        AB.A.delta.a.FP1, AB.A.delta.b.FP2, AB.A.delta.c.F7, 
                        AB.A.delta.d.F3, AB.A.delta.e.Fz, AB.A.delta.f.F4, 
                        AB.A.delta.g.F8, specific.disorder))

# Check for collinearity using Variance Inflation Factor (VIF)
vif_model <- multinom(specific.disorder ~ education + age + sex + IQ + 
                      AB.A.delta.a.FP1 + AB.A.delta.b.FP2 + AB.A.delta.c.F7 + 
                      AB.A.delta.d.F3 + AB.A.delta.e.Fz + AB.A.delta.f.F4 + 
                      AB.A.delta.g.F8, data = df, maxit = 1000)
vif_values <- vif(vif_model)
print(vif_values)

# Fit multinomial logistic regression model
fit_disorder <- multinom_reg(mode = "classification") %>%
  set_engine("nnet", maxit = 1000) %>%  # Specify maxit in set_engine
  fit(specific.disorder ~ education + age + sex + IQ + 
        AB.A.delta.a.FP1 + AB.A.delta.b.FP2 + AB.A.delta.c.F7 + 
        AB.A.delta.d.F3 + AB.A.delta.e.Fz + AB.A.delta.f.F4 + 
        AB.A.delta.g.F8, data = df)

# Extract model coefficients with confidence intervals
model_results <- tidy(fit_disorder, conf.int = TRUE)

# Display model results
model_results %>%
  select(term, y.level, estimate, std.error, conf.low, conf.high) %>%
  knitr::kable(digits = 3, caption = "Model Coefficients and Confidence Intervals")

```


