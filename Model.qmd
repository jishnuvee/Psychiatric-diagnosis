---
title: "Model"
format: html
execute: 
  echo: false
---

# EEG Multinomial Regression with Individual Delta Power

The following equation represents the multinomial logistic regression model used to predict psychiatric disorders from demographic and EEG delta power variables:

$$
\begin{align*}
\log\left( \frac{P(\texttt{specific.disorder} = k)}{P(\texttt{specific.disorder} = \text{baseline})} \right) =\ 
& \beta_{0,k} + \beta_{1,k} \cdot \texttt{education} + \beta_{2,k} \cdot \texttt{age} + \beta_{3,k} \cdot \texttt{sex} + \beta_{4,k} \cdot \texttt{IQ} \\
& + \beta_{5,k} \cdot \texttt{AB.A.delta.a.FP1} + \beta_{6,k} \cdot \texttt{AB.A.delta.b.FP2} \\
& + \beta_{7,k} \cdot \texttt{AB.A.delta.c.F7} + \beta_{8,k} \cdot \texttt{AB.A.delta.d.F3} \\
& + \beta_{9,k} \cdot \texttt{AB.A.delta.e.Fz} + \beta_{10,k} \cdot \texttt{AB.A.delta.f.F4} \\
& + \beta_{11,k} \cdot \texttt{AB.A.delta.g.F8}
\end{align*}
$$


```{r}
#| warning: false
#| message: false

# Load required packages
suppressPackageStartupMessages({
  library(tidyverse)
  library(tidymodels)
  library(nnet)    # For multinom()
  library(car)     # For VIF
  library(knitr)   # For kable output
   library(marginaleffects)
})

set.seed(123)

# Load dataset
df <- read_csv("EEG.machinelearing_data_BRMH.csv")

# Preprocess
df <- df %>%
  mutate(
    sex = as.factor(sex),
    specific.disorder = relevel(as.factor(specific.disorder), ref = "Healthy control")
  ) %>%
  filter(complete.cases(education, age, sex, IQ, 
                        AB.A.delta.a.FP1, AB.A.delta.b.FP2, AB.A.delta.c.F7, 
                        AB.A.delta.d.F3, AB.A.delta.e.Fz, AB.A.delta.f.F4, 
                        AB.A.delta.g.F8, specific.disorder))

# VIF using multinom
# For tidymodels approach
fit_disorder <- multinom_reg(mode = "classification") %>%
  set_engine("nnet", maxit = 1000, trace = FALSE) %>%
  fit(specific.disorder ~ education + age + sex + IQ +
         AB.A.delta.a.FP1 + AB.A.delta.b.FP2 + AB.A.delta.c.F7 +
         AB.A.delta.d.F3 + AB.A.delta.e.Fz + AB.A.delta.f.F4 +
         AB.A.delta.g.F8, data = df)

# For the VIF model
vif_model <- multinom(specific.disorder ~ education + age + sex + IQ +
                       AB.A.delta.a.FP1 + AB.A.delta.b.FP2 + AB.A.delta.c.F7 +
                       AB.A.delta.d.F3 + AB.A.delta.e.Fz + AB.A.delta.f.F4 +
                       AB.A.delta.g.F8, data = df, maxit = 1000, trace = FALSE)

                      
# Extract and display model results
tidy(fit_disorder, conf.int = TRUE) %>%
  select(term, y.level, estimate, std.error, conf.low, conf.high) %>%
  kable(digits = 3, caption = "Model Coefficients and Confidence Intervals")

```


